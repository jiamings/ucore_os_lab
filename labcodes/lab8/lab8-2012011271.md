### Lab 8

#### Exercise 1

在`sfs_inode.c`中的`sfs_io_nolock`中实现文件操作需要分成三步：

1. 操作的内容起始位置与块地址不对齐时的头部读取
2. 对对齐内容进行操作
3. 操作尾部与地址不对齐的部分

对于头部的不对齐内容：

1. 先用`blkoff`获得头部的溢出部分地址
2. 用`sfs_bmap_load_nolock`根据块号获得inode
3. 用`sfs_buf_op`函数指针进行读写操作
4. 更新内容大小，缓冲区指针等信息

对于中间的对齐内容：

1. 用`sfs_bmap_load_nolock`根据块号获得inode
2. 根据`inode`利用`sfs_block_op`对块进行操作
3. 更新缓冲区指针和成功操作的内容大小

对于尾部的不对齐内容的操作与头部类似。



#### UNIX的PIPE机制设计方案

为了实现PIPE机制，首先需要实现以下的系统调用：

- pipe_new：创建一个pipe
- pipe_read：对pipe中的数据进行读取
- pipe_write：向pipe中写入数据

管道内部的数据是一个环状链表，在尾部不断地添加数据，在头部进行读取。若管道中没有数据的时候，进行读操作的线程需要释放运行权限进行调度，等待数据的填充。

#### Exercise 2

基于文件系统的执行程序机制实现

`proghdr* ph`和`elfhdr* elf`和各个代码段通过一个`load_icode_read`来从文件系统中读取。读取完毕后，关闭`fd`文件。在运行栈上压入参数`kargv`，以及参数的的个数`argc`信息。

如果不修改`tf->tf_esp`会导致panic

进行了以上的修改之后，`load_icode`就可以成功从文件系统加载程序，添加参数并运行了。

#### UNIX的硬链接和软链接机制

- 硬链接：当创建一个硬链接的时候，其中的disk_inode修改为指向被链接的文件的inode
- 软链接：在存储器中软链接，当访问文件的时候，文件访问会尝试打开其指向的位置，直到找到了一个真实文件或者超过了链接的跳转次数。



